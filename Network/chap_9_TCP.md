# ---- 전송계층 기능 ----
- 데이터링크계층과 유사
    - 오류제어, 흐름제어, 데이터 순서화 등 제공
- 데이터링크와 차이점
    - 데이터계층
        - 물리적으로 1:1 연결 호스트사이의 전송
        - 직접 연결
    - 전송계층
        - 논리적으로 1:1 연결 호스트 사이의 전송
        - 종단간(end-to-end), 양끝단
---
### 주요기능
- 흐름제어
    - 기본목적을 비롯해 유사점 多 ---> 계층2(데이터)와 다른 버퍼관리 필요
    - 수신자가 송신자의 전송속도보다 느리게 수신 ---> 버퍼용량초과로 데이터분실 ---> 타임아웃기능을 통한 재전송 유발
    - 수신자가 슬라이딩 윈도우 프로토콜의 윈도우 하단값 조정 ---> 송신자가 보낼 수 있는 패킷 한계설정
- 오류제어
    - 데이터 변형, 분실 오류 시 재전송기능으로 복구
    - 수신자 요구(NAK)/ 송신자 판단(타임아웃)하는 방법 사용
    - 선로 오류보다 각 계층의 S/W 동작과정 중에 분실하는 경우 대부분
        - 네트워크 계층의 기능적 한계
        - 잘못된 위치, 경로 정보
- 분할, 병합
    - 상위계층에서 요구한 데이터 크기가 전송계층에서 처리할 수 있는 크기보다 큰 경우
    - 분할
    - 병합
- 서비스 프리미티브
    - 네트워크 계층 --> 대부분 비연결형 서비스 프리미티브가 정의
    - 전송계층 --> 비연결형, 신뢰성이 향상된 연결형 서비스 모두 제공
---
### 전송계층 설계시 고려사항
- 주소표현
    - TSAP(transport service access point) = 네트워크계층 호스트IP주소 + 전송계층 포트번호
    - IP주소
        - 네트워크와 호스트의 계층적 특성
        - 도메인 주소 = 구조적 특징
        - 위치정보 관련 = 비구조적 특징
            - 주소 바탕으로 위치 파악X
    - 구조적
        - 여러개 계층적 필드로 구분 ---> 각 필드는 상하 계층관계 표시
        - 포트번호 
            - 하나의 컴퓨터에 다수 포트 존재(통신 프로세스 구별)
        - ex) 대한민국:서울:한국대학교:정보통신공학과:네트워크연구실:홍길동:50
    - 비구조적
        - 값만 해석 ---> 논리적 위치 파악X
        - 값 자체에 위치가 아닌 다른 중요한 정보를 담고 있는 경우
            - 초드앟ㄱ교 반번호, 일련번호
- 멀티플렉싱
    - 개별적으로 설정된 TPDU(transport protocol data unity)의 주소가 동일 ---> 하나의 가상회선에 실어 보내는 것이 유리
    - 종류
        - 상향
            - 다수 전송계층 연결을 하부 네트워크 계층에서 하나의 연결로 지원
            - 네트워크계층의 가상회선 연결 개수를 감소
        - 하향
            - 하나의 전송 연결에 네트워크계층 다수의 가상회선을 지원
            - 멀티미디어 전송에 유리
- 연결설정
    - 양자 합의 필요
        - 한쪽 연결설정 요구 = Conn_Req
        - 상대방 연결 수락응답 = Conn_Ack
    - 2단계 연결설정
        - 최소한 단계
        - 수신단에서 거부가능
    - 실제로 프리미티브 전달 과정에서 분실, 변형, 복사 가능성有 ---> 문제들 고려
    - 3단계 설정
        - 3번째 Data_Req는 Conn_Ack에 대한 응답기능도 수행
        - 보낼 데이터 X ---> Conn_Ack(y,x)에 대한 응답을 따로 보내야 함
- 연결해제
    - 일방적 연결해제
        - 어느 한쪽의 Disc_req로 전체 연결 해제
        - 상대방이 송신할 데이터가 있어도 종료
    - 점진적 연결해제
        - 논리적으로 2개의 단방향 연결지원
        - 어느 한쪽에서 해제 요청 ---> 그 프로세스가 송신하는 연결만 해제
        - 양쪽 모두 Disc_req 전송해야 해제됨
---
---
# ---- TCP(transport control protocol) ----
- 주요기능
    - 연결형 서비스 제공
    - 전이중 방식의 양방향 가상회선 제공
    - 신뢰성 있는 데이터 전송보장
- 일반적으로 전송계층 프로토콜은 운영체제 내부기능 구현
- 데이터를 세그먼트 블록단위로 분할 전송
    - 블록 크기 ---> 네트워크 부하도, 위도우크기 등에 영향
    - 가변크기
    - 세그먼트당 순서번호 부여X
    - 세그먼트에 실어보내는 데이터 바이트 수를 순서번호에 반영
- 상위게층에서 연결형, 비연결 서비스 선택 ---> 전송계층 프로토콜(TCP, UDP)선택
    - 연결유무, 신뢰성 외에도 해당 전송계층 선택 시 각 응용 프로그램에서 수행해야 하는 기능에 대해 이해 필요
    - 데이터 링크 계층에는 다양한 네트워크 인터페이스 有
---
### 헤더
- 20~40byte
- 필드
    - source port/ destination port
        - 송수신 포트번호
    - sequence number
        - 순서번호
        - 세그먼트 내 바이트 수
        - 0~2^32-1
        - 최초 시작 순서번호 = 임의로 설정 --> 연결 재설정 시 혼선 방지
    - acknowledgement number
        - 응답번호
        - ACK플래그가 지정된 경우에만 유효
        - 다음 수신할 데이터 지정
        - 연결설정, 해제와 같이 데이터가 없어도 1씩 증가
    - data offset
        - 데이터 시작 위치
        - TCP헤더 크기
    - window
        - 수신윈도우 버퍼크기 지정
        - 0 = 송신프로세스 전송중지
    - checksum
        - 헤더, 데이터에 대한 오류 검출
        - IP 프로토콜에서 사용하는 오류검출방식 이용
    - urgent pointer
        - 송신프로세스가 긴급히 처리하고자 하는 데이터 처리
        - URG 플래그가 지정된 경우에만 유효
        - 플래그 해제 ---> 정상처리
---
### 헤더 플래그비트
- URG
    - urgent pointer 유효
- ACK
    - acknowledgement number 유효
    - 정상적인 피기배킹 환경 --> 연결설정 첫번째 세그먼트 제외한 모든 세그먼트에서 1로 설정
- PSH
    - 현재 세그먼트 데이터를 즉시 상위계층에 전달하도록 지시
    - 응답 도착 = 요청한 모든 데이터가 상위계층에 전달되었음을 의미
- RST
    - 연결 리셋, 유효하지 않은 세그먼트에 대한 응답
    - 연결 리셋 ---> 이미 전송했지만 정상응답 못받은 세그먼트 재전송
- SYN
    - 연결 설정 요청
- FIN
    - 점진적 연결종료 요청
    - 한 방향만 연결 해제
    - 쌍방이 FIN 보내야 모든연결 해제
---
### 포트번호
- TCP, UDP 프로토콜이 상위계층에 저공하는 주소표현 방식
- TCP, UDP가 독립적으로 관리
    - TCP, UDP에서 동일한 번호를 가질 수 있음 --> 각각 별개 포트
    - 하나의 서비스가 동일한 TCP, UDP포트번호 가질 수 있음
- unix 계열 --> /etc/services에 저장
- 클라이언트-서버 방식 ---> 클라이언트는 (서버Ip주소 + 포트번호) 알아야 통신가능
- well-known포트
    - 많이 사용하는 인터넷 서비스에 고정된 포트번호 할당
- 서버 포트번호 ---> well-known포트번호 이용
- 클라이언트 ---> 시스템에서 임의 포트 자동할당
---
---
# ---- TCP 데이터 전송 ----
- 3단계 설정
    - A프로세스 연결설정 요청
        - 임의 순서번호(10) 선택 ---> SYN(연결설정요청) 전송
    - B프로세스 응답
        - 10에 대한 응답(ACK) & 임의 순서번호 선택(50) ---> SYN전송
    - A프로세스가 현재 보낼 데이터X --> 50에 대한 응답(ACK)전송
- 정상적인 데이터 전송
    - 3번째 연결설정단계부터 데이터전송 가능
    - 데이터크기만큼 순서번호 증가
    - 흐럼제어 --> 윈도우 필드 사용
- 데이터전송 오류
    - 동일한 순서번호 ---> 중복으로 판단, 폐기
    - 순서번호 빠지는 경우 ---> 분실로 판단
    - NAK 지원X
        - 분실, 변형 시 수신프로세스는 응답X
        - 송신측에서 타임아웃기능으로 재전송
- TCP 연결해제
    - 해제하고자 하는 측에서 FIN전송
    - FIN 수신측에서 보낼 데이터가 있는 경우 계속 송신가능