# ---- 네트워크 계층 기능 ----
### 기본 기능 - 라우팅
- 송수신 호스트 사이의 패킷 전달 경로 선택
- 임의 라우터가 획득한 정보를 각 라우터에 통보 ---> 정보공유
    - 개별 라우터 도착시간 차이 ---> 정보 불일치 발생가능
    - 변화되는 상황에서 일관성 유지 관건
- 고려사항
    - 공평원칙
        - 다른 패킷 우선처리를 위해 다른 패킷이 손해 보면 안됨
    - 효율원칙
        - 전체 네트워크 효율성 고려
        - 패킷 평균지연시간, 중간 거쳐가는 라우터 수...
- 종류
    - 정적
        - 패킷 전송 전 경로 정보를 미리 저장하여 중개
        - 최적의 라우팅 정보를 개별 라우터에 저장, 관린
        - 단점
            - 경로 정보 갱신 어려움 ---> 네트워크 변화, 혼잡도 대처 부족
    - 동적
        - 네트워크 상황에 따라 경로정보 적절히 변경
        - 경로정보 변경 주기에 따른 보완 가능
        - 단점
            - 복잡한 작업 추가로 필요
            - 경로정보 수집, 관리 ---> 성능저하
- 수반되는 기능
    - 혼잡제어
        - 혼잡
            - 네트워크 패킷 수가 과도하게 증가되는 현상
            - 원인
                - 타임아웃 기능에 의해 패킷 재전송
                    - 타임아웃시간 작으면 혼잡도 증가
                    - 패킷 도착순서가 다른 상황에서 패킷 분실 처리 시 타임아웃 증가
                    - 의도적으로 피기배킹 사용 ---> 응답시간 느려짐 ---> 타임아웃증가
                    - 패킷 생존시간 짧음 ---> 패킷 강제 저거 ---> 타임아웃 증가
            - 제거방식
                - 자원예약방식
                    - 호스트와 서브넷이 미리 네트워크 자원 사용정도를 협상하여 사전에 예약
                    - 단점
                        - 자원낭비 가능성
                - 초크패킷
                    - 출력 경로 사용하는 빈도를 모니터
                    - 한계치 넘으면 송신호스트에 주의표시
                    - 초크패킷을 받은 호스트는 송신 패킷양 줄임 ---> 초크패킷이 더이상 오지 않을 때까지
        - 네트워크에서 전송 능력 문제
        - 예방, 제거 기능 필요
        - 라우팅 알고리즘
            - 혼잡 발생하지 않는 경로 배정하도록 설계
            - 혼잡 발생경로 선택 시 주변으로 혼잡 확대
        - 트레픽 성형
            - 패킷 발생 정도를 네트워크에서 예측 가능한 정도로 조절 필요
            - 리키버킷 알고리즘
                - 데이터에 가변율 입력해서 버퍼에 모아서 고정된 속도로 출력
    - 패킷분할, 병합
        - 상위 계층 데이터 ---> 하위계층(MAC) 프레임 구조 형식으로 캡슐화
        - 송신호스트 ---> 전송 전 적절한 크기로 데이터 분할
        - 수신호스트 ---> 수신된 데이터 병합
- 라우팅 정보 처리
    - 소스라우팅
        - 송신호스트가 패킷 전달경로를 결정
        - 전송 경로는 전송 패킷 내부에 기록
    - 분산라우팅
        - 라우팅 정보 분산 관리
        - 호스트 개수 많을수록 효과적
    - 중앙라우팅
        - 특정 호스트(RCC)가 모든 라우팅정보 관리
        - 송신호스트는 패킷 전송 전 RCC에게 경로정보 얻어서 소스라우팅으로 전송
        - 호스트 개수 많을수록 비효율적
    - 게층라우팅
        - 분산라우팅 + 중앙라우팅
        - 네트워크 규모 클수록 효과적
- 라우팅 테이블
    - 네트워크 구성 형태에 관한 정보 관리
    - 필수정보
        - 목적지
            - 패킷 최종 목적지 호스트주소
        - 다음 홉
            - 목적지까지 전달하기 위한 인접 경로

```
hello 패킷 - 주변 라우터에 보내 주변경로 정보 파악
echo 패킷 - 라우터 사이 전송지연시간 측정
흐름제어 - 송수신 호스트 사이 전송 속도 문제
```
---
### 서비스 종류
- 연결형
    - 데이터 전송 전 데이터 전송경로를 미리 결정
    - 상대적으로 신뢰성 높음
    - TCP
        - 전송계층의 기능 지원
- 비연결형
    - 데이터 전송경로를 사전에 결정하지 않고 패킷 단위로 결정
    - 패킷 전달순서
        - 패킷이 서로 다른 경로로 전송 ---> 도착 순서 일정X
        - 상위계층에서 순서 재조정
    - 패킷 분실 가능성
        - 패킷 100% 도착 보장X
        - 상위계층에서 패킷 분실오류 복구
    - IP
        - 네트워크계층 기능지원
    - UDP
        - 전송계층 기능지원
---
---
# ----라우팅----
### 간단한 라우팅 프로토콜
- 최단경로 라우팅
    - 거리기준 다양, 중간에 거쳐가는 홉 수로 판단
    - 패킷이 목적지로 가는동안 거치는 min(n(라우터)) 경로 선택
    - 기타 거리기준
        - 패킷 전송지연
        - 전송 대역폭
        - 통신비용...
- 플러딩
    - 라우터가 입력된 패킷을 출력 가능한 모든 경로로 중개
    - 네트워크에 무한개 패킷 생성 위험
        - n(홉)를 일정범위로 제한, 제거
    - 중요한 데이터를 모든 호스트에게 동시에 전달하는 환경에서 제한적으로 사용
---
### 거리벡터 프로토콜
- 라우터가 자신과 직접 연결된 주변 라우터에게 라우팅 정보 교환
    - 전체 네트워크에 대한 지식
    - 이웃 라우터에게만 전달
    - 일정 주기로 정보공유
- 교환 정보 = 전체 네트워크에 속하는 개별 네트워크까지 걸리는 거리정보
- 개별 라우터에서 유지하는 필수정보
    - 링크벡터
        - 직접 연결된 네트워크에 대한 연결정보
    - 거리벡터
        - 전체 개별 네트워크에 대한 거리 정보
    - 다음 홉 벡터
        - 개별 네트워크로 가기 위한 다음 홉 정보
- RIP
    - 소규모 네트워크환경에 적합
    - 주변 라우터가 제공하는 거리벡터 정보가 임의의 짧은 시간내에 모두 도착해야 함
        - 현실적으로 구현 어려움 ---> UDP사용 ---> 패킷 손실 가능성
    - 라우팅 정보 수정하는 경우
        - 거리벡터 정보가 새로운 네트워크 주소일 때
        - 목적지까지 지연이 더 적으면 기존경로 대체
        - 거리 벡터 정보가 입력되면 등록정보 수정
    - command
        - 1 = 요구
        - 0 = 응답
        - 초기에 요구 받으면 즉시 응답해야함
    - IP 주소
        - 네트워크지칭
    - metric
        - 목적지까지 거리
---
### 링크상태프로토콜
- 거리벡터 프로토콜 단점 개선
    - 주변상황 변화가 있을 때 주변 라우터까지의 정보를 모든 라우터에 전달
- 플러딩 방식으로 정보 전달
- OSPF(open shortest path first) 프로토콜
    - http://www.netmanias.com/ko/?m=view&id=blog&no=5476
---
### 외부라우팅 프로토콜
- 경로벡터는 경로에 관한 거리 정보값이 필요 없음
- 내부 라우팅 프로토콜과 차이
    - 거리(비용)에 대한 처리과정X
    - 목적지 네트워크에 도착하기 위한 자율 시스템에 대한 내용만 포함
- BGP(border gateway protocol)
    - 인터넷에서 많이 사용
    - 서로 다른 종류의 자율시스템간 정보 교환가능
    - TCP를 이용하여 정보교환
    - 계층적 라우팅 필요
        - 평면적 라우팅은 확장 어려움
        - 목적지에 이르는 거리가 멀수록 더 적은 정보를 이용하는 것이 타당
        - 해결방안
            - 영역계층구조
    - 영역
        - 망을 영역들로 분할
            - 각 영역에서 서브영역 존재가능
        - 망 노드는 계층적 주소 부여
        - 영역내부
            - 각 노드는 다른 노드로 가는 경로 보유
        - 영역외부
            - 각 노드는 다른 상위계층 영역으로 가는 경로만 보유
            - 영역 간 패킷은 적절한 border라우터에게 전달
    - 인터넷의 영역 계층구조
        - 자유 시스템(AS)
            - 하나의 기술적 관리 하에 있는 라우터들 집합
                - AS 안에서는 IGP(interior gateway protocol)와 패킷을 전달하기 위한 공통메트릭 사용
                - 다른 AS로 전달하기 위해서 EGP(exterior) 사용
        - 각 AS는 유일한 ID 할당
            - 16비트
        - AS는 peer 역할
    - 메시지 종류
        - open
            - 연관생성
        - update
            - 경로 관련정보 전달
        - keepalive
            - open에 대한 응답 기능
            - 주기적인 연관확인 기능
        - notification
            - 오류 상태 통보
---
---
# ----IP----
- 특징
    - 비연결형
    - 패킷분할, 병합가능
    - 데이터 checksum 없고 헤더 checksum만 제공
    - best effort
        - 정확한 여부는 확인해야 함
- IP 헤더
    - service type 필드
        - 사용자에게 제공하는 서비스 품질 관련 내용
            - 0~2비트
                - 상위 게층의 응용서비스 환경에 따라 설정
                - 우선순위
                - 111이 가장 높음
            - 3~5비트 = 일반적으로 0
                - 3 = 지연
                - 4 = 전송률
                - 5 = 신뢰성
    - 패킷 분할 관련 필드
        - 상위 계층에서 내려온 데이터가 하나의 패킷으로 전달하기에 너무 큰 경우 분할 전송
        - identification
            - 분할되지 않은 패킷
                - 순차적으로 값 증가
            - 분할된 패킷
                - 동일 번호 부여
        - DF
            - 패킷 분할금지
        - MF
            - 분할된 패킷 처음, 중간 = 1
            - 분할된 패킷 마지막 = 0
        - fragment offset
            - 13bit
            - 분할되기 전 데이터에서의 상대적인 위치 정보
            - 8바이트 배수로 지정
    - 주소관련 필드
        - source 주소
            - 송신호스트 IP 주소
        - destination 주소
            - 수신호스트 IP주소
        - IP 주소체계
            - network
                - NIC에서 할당
            - host
                - 개별망에서 관리
            - class A
            - class B
            - class C
            - class D
            - class E
    - 기타필드
        - version number
            - 일반적으로 IPv4
        - header length
            - 32비트 단위로 표시
            - IPv4의 경우 일반적으로 5
        - packet length
            - 헤더 포함 패킷의 전체 길이
        - time to live(TTL)
            - 패킷 생존시간
            - 라우터 거칠때마다 1씩 감소
            - 0 = 네트워크에서 강제제거
        - transport protocol
            - 상위계층 프로토콜
            - ICMP = 1
            - TCP = 6
            - UDP = 17
        - header checksum
            - 필드값을 0으로 하고 값을 계산하여 채움
            - 헤더 오류 검출
        - options
            - 망관리, 보안목적으로 부여
        - padding
---
### 패킷 분할
- 분할 필요성
    - 각 네트워크에서 다루는 프레임크기 다름
    - 여러 종류 네트워크 걸쳐 패킷 전달
    - 뒤에 따라오는 패킷 있는 경우 MF=1